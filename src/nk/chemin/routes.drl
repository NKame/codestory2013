package codestory2013;

import nk.chemin.DecisionRoutage;
import nk.chemin.Parametre;
import nk.enonces.Monnayeur

rule "PremiereQuestion"
when 
	$dr : DecisionRoutage(decide == false)
	Parametre(nom == "q", valeur == "Quelle est ton adresse email")
then
	$dr.resoudStatique("mail.txt");
	update($dr);
end

rule "Abonnement ML"
when
	$dr : DecisionRoutage(decide == false)
	Parametre(nom == "q", valeur == "Es tu abonne a la mailing list(OUI/NON)")
then
	$dr.resoudStatique("OUI.txt");
	update($dr);
end

rule "Bonheur"
when
	$dr : DecisionRoutage(decide == false)
	Parametre(nom == "q", valeur == "Es tu heureux de participer(OUI/NON)")
then
	$dr.resoudStatique("OUI.txt");
	update($dr);
end

rule "Vas-y balance ton MarkDown"
when
	$dr : DecisionRoutage(decide == false)
	Parametre(nom == "q", valeur == "Es tu pret a recevoir une enonce au format markdown par http post(OUI/NON)")
then
	$dr.resoudStatique("OUI.txt");
	update($dr);
end

rule "Enonce 1 recu"
when
	$dr : DecisionRoutage(decide == false)
	Parametre(nom == "q", valeur == "As tu bien recu le premier enonce(OUI/NON)")
then
	$dr.resoudStatique("OUI.txt");
	update($dr);
end 

rule "Enonce 1"
when
	$dr: DecisionRoutage(decide == false, path matches "/scalaskel/change/[0-9]+")
then
	/* je sais, c'est monstrueux */
	Monnayeur m = new Monnayeur();
	$dr.jsonDirect(m.faitLaMonnaie(Integer.parseInt($dr.getPath().substring($dr.getPath().lastIndexOf("/") + 1), 10)));
	update($dr);
end

rule "Addition"
when
	$dr : DecisionRoutage(decide == false, queryString matches "q=[0-9]+\\+[0-9]+") 
then
	String valeur = $dr.getQueryString();
	int pPos = valeur.indexOf("+");
	int reponse = Integer.parseInt(valeur.substring(2, pPos), 10) + Integer.parseInt(valeur.substring(pPos + 1), 10); 
	$dr.renvoieChaine(String.valueOf(reponse));
	update($dr);
end

rule "Soustraction"
when
	$dr : DecisionRoutage(decide == false, queryString matches "q=[0-9]+-[0-9]+") 
then
	String valeur = $dr.getQueryString();
	int pPos = valeur.indexOf("-");
	int reponse = Integer.parseInt(valeur.substring(2, pPos), 10) - Integer.parseInt(valeur.substring(pPos + 1), 10); 
	$dr.renvoieChaine(String.valueOf(reponse));
	update($dr);
end

rule "Multiplication"
when
	$dr : DecisionRoutage(decide == false, queryString matches "q=[0-9]+\\*[0-9]+") 
then
	String valeur = $dr.getQueryString();
	int pPos = valeur.indexOf("*");
	int reponse = Integer.parseInt(valeur.substring(2, pPos), 10) * Integer.parseInt(valeur.substring(pPos + 1), 10); 
	$dr.renvoieChaine(String.valueOf(reponse));
	update($dr);
end

rule "Division"
when
	$dr : DecisionRoutage(decide == false, queryString matches "q=[0-9]+/[0-9]+") 
then
	String valeur = $dr.getQueryString();
	int pPos = valeur.indexOf("/");
	double diviseur = Double.parseDouble(valeur.substring(pPos + 1));
	if(diviseur != 0) {
		double reponse = Integer.parseInt(valeur.substring(2, pPos), 10) / diviseur;		 
		$dr.renvoieChaine(String.valueOf(reponse));
	} else {
		$dr.renvoieChaine("NaN");
	}
	update($dr);
end 

rule "Question inconnue"
salience -1
when
	$dr : DecisionRoutage(decide == false)
	Parametre(nom == "q", valeur matches ".*\\(OUI/NON\\)")
then
	$dr.resoudStatique("NON.txt");
	update($dr);
end

rule "Favicon"
/* ce serait dommage de la capturer */
when 
	$dr : DecisionRoutage(decide == false, path == "/favicon.ico")
then
	$dr.redirectPermanent("http://www.cynicalturtle.net/kame/themes/kbloggo/css/turtle.gif");
	update($dr);
end

rule "Assistance"
/* tout ce qui est /assistance, on traite en interne */
when
	$dr : DecisionRoutage(decide == false, path matches "/assistance/.*")
then
	$dr.chain();
	update($dr);
end	

rule "Requete inconnue"
salience -100
when
	$dr : DecisionRoutage(decide == false)
then
	$dr.resoudDynamique('/assistance/capture');
	update($dr)
end